# üìã S1-019: Pydantic Output Models (CourseStructure)

## –ú–µ—Ç–∞

–í–∏–∑–Ω–∞—á–∏—Ç–∏ Pydantic-–º–æ–¥–µ–ª—ñ –¥–ª—è structured output ArchitectAgent. –¶—ñ –º–æ–¥–µ–ª—ñ –æ–ø–∏—Å—É—é—Ç—å –ø–æ–≤–Ω—É —ñ—î—Ä–∞—Ä—Ö—ñ—é –∫—É—Ä—Å—É: `CourseStructure` ‚Üí `ModuleOutput` ‚Üí `LessonOutput` ‚Üí `ConceptOutput` + `ExerciseOutput`. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —ñ —è–∫ `response_schema` –¥–ª—è LLM (structured output), —ñ —è–∫ API response schemas, —ñ —è–∫ –ø—Ä–æ–º—ñ–∂–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è persistence (Pydantic ‚Üí ORM mapping).

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü–µ—Ä—à–∞ –∑–∞–¥–∞—á–∞ Epic 4. –ë–ª–æ–∫—É—î S1-020 (prompt ‚Äî –±–æ schema –æ–ø–∏—Å–∞–Ω–∞ –≤ –ø—Ä–æ–º–ø—Ç—ñ), S1-021 (ArchitectAgent ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î `CourseStructure`), S1-022 (persistence ‚Äî –º–∞–ø–ø—ñ–Ω–≥ Pydantic ‚Üí ORM). Epics 1‚Äì3 –∑–∞–≤–µ—Ä—à–µ–Ω—ñ (185 —Ç–µ—Å—Ç—ñ–≤).

–§–∞–π–ª `models/course.py` –≤–∂–µ –º—ñ—Å—Ç–∏—Ç—å `SlideVideoMapEntry` —Ç–∞ `CourseContext` ‚Äî –ø–æ—Ç—Ä—ñ–±–Ω–æ **–¥–æ–¥–∞—Ç–∏** –Ω–æ–≤—ñ –º–æ–¥–µ–ª—ñ, –Ω–µ –≤–∏–¥–∞–ª—è—é—á–∏ —ñ—Å–Ω—É—é—á—ñ.

ORM-–º–æ–¥–µ–ª—ñ (–≤ `storage/orm.py`) –≤–∂–µ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ: `Module`, `Lesson`, `Concept`, `Exercise`. Pydantic-–º–æ–¥–µ–ª—ñ –º–∞—é—Ç—å **—Å—É—Ñ—ñ–∫—Å `Output`** –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è name collision –∑ ORM: `ModuleOutput`, `LessonOutput`, `ConceptOutput`, `ExerciseOutput`.

---

## Acceptance Criteria

- [ ] `SlideRange` ‚Äî start/end slide numbers –¥–ª—è JSONB `Lesson.slide_range`
- [ ] `WebReference` ‚Äî url, title, description –¥–ª—è JSONB `Concept.web_references`
- [ ] `ExerciseOutput` ‚Äî description, reference_solution, grading_criteria, difficulty_level (1‚Äì5)
- [ ] `ConceptOutput` ‚Äî title, definition, examples, timecodes, slide_references, web_references
- [ ] `LessonOutput` ‚Äî title, video_start/end_timecode, slide_range, concepts, exercises
- [ ] `ModuleOutput` ‚Äî title, lessons
- [ ] `CourseStructure` ‚Äî title, description, modules (top-level response schema)
- [ ] Defaults: optional fields –º–∞—é—Ç—å sensible defaults (empty lists, None)
- [ ] Validation: `difficulty_level` ge=1, le=5
- [ ] Exports –≤ `models/__init__.py`
- [ ] ~10 unit-—Ç–µ—Å—Ç—ñ–≤, –≤—Å—ñ –∑–µ–ª–µ–Ω—ñ
- [ ] `make check` –ø—Ä–æ—Ö–æ–¥–∏—Ç—å

---

## Pydantic-–º–æ–¥–µ–ª—ñ

### src/course_supporter/models/course.py (–¥–æ–¥–∞—Ç–∏ –¥–æ —ñ—Å–Ω—É—é—á–æ–≥–æ)

```python
# --- Existing code (DO NOT REMOVE) ---
# SlideVideoMapEntry, CourseContext

# --- New models for ArchitectAgent output ---

class SlideRange(BaseModel):
    """Slide range for a lesson.

    Maps to ORM Lesson.slide_range (JSONB).
    Example: {"start": 1, "end": 15}
    """

    start: int
    end: int


class WebReference(BaseModel):
    """External web reference for a concept.

    Maps to ORM Concept.web_references (JSONB list).
    """

    url: str
    title: str = ""
    description: str = ""


class ExerciseOutput(BaseModel):
    """Exercise generated by ArchitectAgent.

    Suffix 'Output' to avoid collision with ORM Exercise class.
    Maps to ORM Exercise table fields.
    """

    description: str
    reference_solution: str | None = None
    grading_criteria: str | None = None
    difficulty_level: int = Field(default=3, ge=1, le=5)


class ConceptOutput(BaseModel):
    """Concept card generated by ArchitectAgent.

    Contains definition, examples, and cross-references
    to video timecodes, slides, and web resources.
    Maps to ORM Concept table fields.
    """

    title: str
    definition: str
    examples: list[str] = Field(default_factory=list)
    timecodes: list[str] = Field(default_factory=list)
    slide_references: list[int] = Field(default_factory=list)
    web_references: list[WebReference] = Field(default_factory=list)


class LessonOutput(BaseModel):
    """Lesson generated by ArchitectAgent.

    Contains concepts and exercises, plus cross-references
    to video timecodes and slide ranges.
    """

    title: str
    video_start_timecode: str | None = None
    video_end_timecode: str | None = None
    slide_range: SlideRange | None = None
    concepts: list[ConceptOutput] = Field(default_factory=list)
    exercises: list[ExerciseOutput] = Field(default_factory=list)


class ModuleOutput(BaseModel):
    """Module (section) of a course generated by ArchitectAgent."""

    title: str
    lessons: list[LessonOutput] = Field(default_factory=list)


class CourseStructure(BaseModel):
    """Top-level course structure generated by ArchitectAgent.

    This is the response_schema passed to LLM structured output.
    The LLM returns JSON conforming to this schema.
    """

    title: str
    description: str = ""
    modules: list[ModuleOutput] = Field(default_factory=list)
```

### src/course_supporter/models/__init__.py (–æ–Ω–æ–≤–∏—Ç–∏ exports)

```python
"""Pydantic schemas for course-supporter domain models."""

from course_supporter.models.course import (
    CourseContext,
    CourseStructure,
    ExerciseOutput,
    LessonOutput,
    ModuleOutput,
    SlideRange,
    SlideVideoMapEntry,
    WebReference,
)
from course_supporter.models.source import (
    ChunkType,
    ContentChunk,
    SourceDocument,
    SourceType,
)

# Re-export ConceptOutput for convenience
from course_supporter.models.course import ConceptOutput

__all__ = [
    "ChunkType",
    "ConceptOutput",
    "ContentChunk",
    "CourseContext",
    "CourseStructure",
    "ExerciseOutput",
    "LessonOutput",
    "ModuleOutput",
    "SlideRange",
    "SlideVideoMapEntry",
    "SourceDocument",
    "SourceType",
    "WebReference",
]
```

---

## –¢–µ—Å—Ç–∏

### tests/unit/test_course_structure.py

```python
"""Tests for CourseStructure Pydantic output models."""

import pytest
from pydantic import ValidationError

from course_supporter.models.course import (
    ConceptOutput,
    CourseStructure,
    ExerciseOutput,
    LessonOutput,
    ModuleOutput,
    SlideRange,
    WebReference,
)


class TestSlideRange:
    def test_slide_range_basic(self) -> None:
        """SlideRange with start and end."""
        sr = SlideRange(start=1, end=15)
        assert sr.start == 1
        assert sr.end == 15

    def test_slide_range_serialization(self) -> None:
        """SlideRange serializes to dict matching JSONB format."""
        sr = SlideRange(start=5, end=20)
        data = sr.model_dump()
        assert data == {"start": 5, "end": 20}


class TestWebReference:
    def test_web_reference_defaults(self) -> None:
        """WebReference with only url, title and description default to ''."""
        ref = WebReference(url="https://example.com")
        assert ref.url == "https://example.com"
        assert ref.title == ""
        assert ref.description == ""


class TestExerciseOutput:
    def test_exercise_defaults(self) -> None:
        """ExerciseOutput defaults: difficulty=3, optional fields None."""
        ex = ExerciseOutput(description="Write a function")
        assert ex.difficulty_level == 3
        assert ex.reference_solution is None
        assert ex.grading_criteria is None

    def test_exercise_difficulty_validation_min(self) -> None:
        """ExerciseOutput rejects difficulty_level < 1."""
        with pytest.raises(ValidationError):
            ExerciseOutput(description="test", difficulty_level=0)

    def test_exercise_difficulty_validation_max(self) -> None:
        """ExerciseOutput rejects difficulty_level > 5."""
        with pytest.raises(ValidationError):
            ExerciseOutput(description="test", difficulty_level=6)

    def test_exercise_difficulty_valid_range(self) -> None:
        """ExerciseOutput accepts difficulty_level 1‚Äì5."""
        for level in (1, 2, 3, 4, 5):
            ex = ExerciseOutput(description="test", difficulty_level=level)
            assert ex.difficulty_level == level


class TestConceptOutput:
    def test_concept_defaults(self) -> None:
        """ConceptOutput defaults: empty lists for optional fields."""
        c = ConceptOutput(title="OOP", definition="Object-oriented programming")
        assert c.examples == []
        assert c.timecodes == []
        assert c.slide_references == []
        assert c.web_references == []


class TestCourseStructure:
    def test_course_structure_minimal(self) -> None:
        """CourseStructure with just title."""
        cs = CourseStructure(title="Python Course")
        assert cs.title == "Python Course"
        assert cs.description == ""
        assert cs.modules == []

    def test_course_structure_full_hierarchy(self) -> None:
        """Full hierarchy: CourseStructure ‚Üí Module ‚Üí Lesson ‚Üí Concept + Exercise."""
        structure = CourseStructure(
            title="Python 101",
            description="Intro to Python",
            modules=[
                ModuleOutput(
                    title="Basics",
                    lessons=[
                        LessonOutput(
                            title="Variables",
                            video_start_timecode="00:00:00",
                            video_end_timecode="00:15:30",
                            slide_range=SlideRange(start=1, end=10),
                            concepts=[
                                ConceptOutput(
                                    title="Variable Assignment",
                                    definition="Binding a name to a value",
                                    examples=["x = 42"],
                                    timecodes=["00:02:15"],
                                    slide_references=[2, 3],
                                    web_references=[
                                        WebReference(
                                            url="https://docs.python.org",
                                            title="Python Docs",
                                        )
                                    ],
                                )
                            ],
                            exercises=[
                                ExerciseOutput(
                                    description="Create variables of different types",
                                    difficulty_level=1,
                                )
                            ],
                        )
                    ],
                )
            ],
        )
        assert len(structure.modules) == 1
        assert len(structure.modules[0].lessons) == 1
        lesson = structure.modules[0].lessons[0]
        assert lesson.slide_range is not None
        assert lesson.slide_range.start == 1
        assert len(lesson.concepts) == 1
        assert len(lesson.exercises) == 1
        assert lesson.concepts[0].web_references[0].title == "Python Docs"

    def test_course_structure_serialization_round_trip(self) -> None:
        """CourseStructure serializes to JSON and deserializes back."""
        original = CourseStructure(
            title="Test",
            modules=[
                ModuleOutput(
                    title="M1",
                    lessons=[
                        LessonOutput(
                            title="L1",
                            concepts=[
                                ConceptOutput(title="C1", definition="Def1")
                            ],
                        )
                    ],
                )
            ],
        )
        json_str = original.model_dump_json()
        restored = CourseStructure.model_validate_json(json_str)
        assert restored == original
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
src/course_supporter/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # UPDATE: add new exports
‚îÇ   ‚îî‚îÄ‚îÄ course.py            # UPDATE: add 7 new models after existing code

tests/unit/
‚îî‚îÄ‚îÄ test_course_structure.py  # NEW: ~10 tests
```

---

## –ö—Ä–æ–∫–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

1. –î–æ–¥–∞—Ç–∏ 7 –Ω–æ–≤–∏—Ö –º–æ–¥–µ–ª–µ–π –¥–æ `models/course.py` (–ø—ñ—Å–ª—è `CourseContext`)
2. –û–Ω–æ–≤–∏—Ç–∏ `models/__init__.py` ‚Äî –¥–æ–¥–∞—Ç–∏ exports
3. –°—Ç–≤–æ—Ä–∏—Ç–∏ `tests/unit/test_course_structure.py`
4. `make check`

---

## –ü—Ä–∏–º—ñ—Ç–∫–∏

- **Output —Å—É—Ñ—ñ–∫—Å**: `ExerciseOutput`, `ConceptOutput`, `LessonOutput`, `ModuleOutput` ‚Äî —â–æ–± –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É–≤–∞—Ç–∏ –∑ ORM `Exercise`, `Concept`, `Lesson`, `Module` —ñ–∑ `storage/orm.py`. `CourseStructure` —ñ `SlideRange` –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å.
- **difficulty_level**: `ge=1, le=5` ‚Äî –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ —Ä—ñ–≤–Ω—ñ Pydantic. ORM `Exercise.difficulty_level` ‚Äî nullable Integer –±–µ–∑ constraint. Pydantic —î –µ–¥–∏–Ω–∏–º –¥–∂–µ—Ä–µ–ª–æ–º –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó.
- **SlideRange vs JSONB**: ORM `Lesson.slide_range` ‚Äî `JSONB`. Pydantic `SlideRange` —Å–µ—Ä—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è —è–∫ `{"start": N, "end": M}`, —â–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É –≤ JSONB.
- **web_references**: ORM `Concept.web_references` ‚Äî `JSONB` (list). –ö–æ–∂–µ–Ω –µ–ª–µ–º–µ–Ω—Ç ‚Äî `WebReference` —Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π —è–∫ dict.
- **examples / timecodes / slide_references**: ORM –∑–±–µ—Ä—ñ–≥–∞—î —è–∫ `JSONB` (list). Pydantic –º–æ–¥–µ–ª—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å typed lists (`list[str]`, `list[int]`).
